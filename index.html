<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="moment.js"></script>
  <script src="https://connect.facebook.net/en_US/all.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">

<style type="text/css">

h4{
  margin-top: 0; 
}
@media(max-width: 480px) {
  h4 {
    font-size: 10pt;
  }
}

</style>
<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

</head>
<body >
  <div id='noclue' class='container'></div>
  <script type="text/javascript">

  var accessToken = "CAANjBmdVSEcBACyfLUuGiZBkZBZCCI1wWub5T17ZCtzdyKLXV8QU4kA3a9JCDtfDxz3LmQZCRZA0llSpg3l5JthypVRBbwJSeMlUmyZCTCZAbT4SZBn6HDUUrB4omEQdNoYxxA1u6ql1ZBKCiwA5AGBMhaeJVkCaNyfZBfHSTweVtdQWFXZBLM2xDhrXErssZAZBTQJmWCQ8sfc8uZAzwZDZD";
  var text = "";
  var d = new Date();
  var today = d.getFullYear() + "-" + (d.getMonth() + 1) + "-" + d.getDate();
  var eventData = [];
  var param = "/events?fields=name,description,start_time,end_time,place,picture.type(large){url}&since=" + today;
  var fb_urls = ['/RUPAPresents','/RUOCSA','/ruaacc','/youth.eagleton','/Cookiesncrepesnb','/rutgersmad','/Rutgers.psa'];

  FB.init({
          appId      : '953304084727879',
          xfbml      : true,
          version    : 'v2.4'
  });

  FB.getLoginStatus(function(response) {
    if (response.status === 'connected') {
        accessToken = response.authResponse.accessToken;
    }else if (response.status !== 'not_authorized') {
      FB.login(function(response) {
        if (response.authResponse) {
          accessToken = response.authResponse.accessToken;
        }
      },true, {scope: 'user_events'});
   } 
 });

  for (var i = 0; i < fb_urls.length; i++) {
    FB.api(fb_urls[i]+param,{access_token: accessToken }, function(response) {
      loopOverResponse(response.data);
    });
  };


  function loopOverResponse(data){
    if(data === undefined) return;
    for (var i = 0; i < data.length; i++){
      if(data[i].description.search(/free|drinks|prize|giveaway|bbq/i) == -1) continue;
      var location = (data[i].place === undefined || data[i].place.location == undefined) ? " " : data[i].place.location.street + ", " + data[i].place.location.city + " " + data[i].place.location.state;
      var time = moment(data[i].start_time).format("dddd, MMMM D, YYYY (h:mm A");
      if(data[i].end_time) {
        time += " - " + moment(data[i].end_time).format("h:mm A)");
      }else{
        time += ")";
      }
      var img_url = data[i].picture.data.url;
      var eventItem = [data[i].id.toString(),data[i].name,img_url,time,location,data[i].description];
      eventData.push(eventItem);
    }
  }
  // get the upcoming event link and using that link find the event info.
  function makeAjaxReq(org_url,callback){
  $.ajax({
      type: 'GET',
      url: org_url,
      dataType: 'html',
      success: callback
    });
  }


  function findEvents(data){
    var itemList = $(data).find('item');
    for(var i = 0; i < itemList.length; i++){
      var item = $(itemList[i]);
      var event_title = item.contents()[3].nodeValue;
      if (event_title == null) event_title = " ";
      var descr_text = item.find('description').text();
      if(descr_text.search(/free\sfood|drinks|games|prize|pizza|giveaway|bbq/i) == -1) continue;
      var img_url = item.find('enclosure').attr('url');
      var time = $.parseHTML(descr_text)[0].innerText;
      var location = $.parseHTML(descr_text)[2].innerText.replace("Location: ","");
      var description = $.parseHTML(descr_text)[4].innerText;
      var eventItem = ["0",event_title,img_url,time,location,description];
      eventData.push(eventItem);
    }
    changeURL();
  }

  function changeURL(){
    var temp = [];
    $.when.apply($, temp).then(function() {
             var xg=arguments; // The array of resolved objects as a pseudo-array
    
             for (var i = xg.length - 1; i >= 0; i--) {
               eventData.push(xg[i]);
             };
          display();  
    })    
  }

  function display(){
    for(var z = 0; z < eventData.length; z++){
      var item = eventData[z];
      $('#noclue').append("<div class=\"row item\"><div class=\"col-xs-2\"><img class='img-responsive img-rounded' src=\"" + item[2] + "\" height=\"150\" width=\"160\"/></div><div class='col-xs-10'><h4>" + item[1] + "</h4><em> " + item[3] + "</em><br>" + item[4] + "<br>" + item[5] + "</div></div><br></div><hr>");
    }
  }

  makeAjaxReq("https://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20html%20where%20url%20%3D%20%22https%3A%2F%2Frutgers.collegiatelink.net%2FEventRss%2FEventsRss%22%20and%20xpath%3D%22%2F%2Fitem%22&diagnostics=true",findEvents);


  </script>

   <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-60013456-1");
            pageTracker._trackPageview();
            } catch(err) {}
     </script>

</body>
</html>